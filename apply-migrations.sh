#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π –∫ –Ω–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

DATABASE_URL="postgresql://rsya_user:StrongPass_2024_RSYa@158.160.56.38:5432/rsya_cleaner"

echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –∫ –Ω–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
echo "Database: $DATABASE_URL"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
psql "$DATABASE_URL" -c "SELECT version();" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!"
    echo "–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ:"
    echo "1. PostgreSQL –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    echo "2. –ü–æ—Ä—Ç 5432 –æ—Ç–∫—Ä—ã—Ç"
    echo "3. Credentials –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ"
    exit 1
fi

echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
echo ""

# –°—á—ë—Ç—á–∏–∫ –º–∏–≥—Ä–∞—Ü–∏–π
SUCCESS=0
FAILED=0

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
for migration in db_migrations/V*.sql; do
    filename=$(basename "$migration")
    echo "üìù –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: $filename"
    
    psql "$DATABASE_URL" -f "$migration" > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ"
        ((SUCCESS++))
    else
        echo "   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞)"
        ((FAILED++))
    fi
done

echo ""
echo "=========================================="
echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ: $SUCCESS –º–∏–≥—Ä–∞—Ü–∏–π"
echo "‚ö†Ô∏è  –° –æ—à–∏–±–∫–∞–º–∏: $FAILED –º–∏–≥—Ä–∞—Ü–∏–π"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü..."
psql "$DATABASE_URL" -c "\dt" 2>&1 | grep "public"

echo ""
echo "üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "–¢–≤–æ–π DATABASE_URL –¥–ª—è GitHub —Å–µ–∫—Ä–µ—Ç–æ–≤:"
echo "$DATABASE_URL"
