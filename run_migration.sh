#!/bin/bash

# ============================================================
# –°–ö–†–ò–ü–¢ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –ú–ò–ì–†–ê–¶–ò–ò
# ============================================================

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo ""

# –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø (–ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ò!)
# ============================================================
read -p "–í–≤–µ–¥–∏ HOST (–Ω–∞–ø—Ä–∏–º–µ—Ä, localhost): " DB_HOST
read -p "–í–≤–µ–¥–∏ PORT (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5432): " DB_PORT
DB_PORT=${DB_PORT:-5432}
read -p "–í–≤–µ–¥–∏ USER: " DB_USER
DB_NAME="t_p97630513_yandex_cleaning_serv"

echo ""
echo "üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "   HOST: $DB_HOST"
echo "   PORT: $DB_PORT"
echo "   USER: $DB_USER"
echo "   DATABASE: $DB_NAME"
echo ""

read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " CONFIRM
if [ "$CONFIRM" != "y" ]; then
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 1
fi

# ============================================================
# –®–ê–ì 1: –ë–≠–ö–ê–ü
# ============================================================
echo ""
echo "üíæ –®–∞–≥ 1/3: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞..."
BACKUP_FILE="backup_before_migration_$(date +%Y%m%d_%H%M%S).sql"
pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞"
    exit 1
fi

# ============================================================
# –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´
# ============================================================
echo ""
echo "üîç –®–∞–≥ 2/3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã..."
psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f CHECK_DATABASE_STRUCTURE.sql

if [ $? -eq 0 ]; then
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
else
    echo "‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
fi

echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π? (y/n): " CONFIRM2
if [ "$CONFIRM2" != "y" ]; then
    echo "‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 1
fi

# ============================================================
# –®–ê–ì 3: –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ú–ò–ì–†–ê–¶–ò–ò
# ============================================================
echo ""
echo "üöÄ –®–∞–≥ 3/3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏..."
psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f MIGRATION_FULL.sql

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ‚úÖ‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê! ‚úÖ‚úÖ‚úÖ"
    echo ""
    echo "üìä –°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:"
    echo "   - partners (–ø–∞—Ä—Ç–Ω–µ—Ä—ã)"
    echo "   - referrals (—Ä–µ—Ñ–µ—Ä–∞–ª—ã)"
    echo "   - referral_clicks (–∫–ª–∏–∫–∏)"
    echo "   - partner_payouts (–≤—ã–ø–ª–∞—Ç—ã)"
    echo "   - rsya_queue_snapshots (—Å–Ω–∞–ø—à–æ—Ç—ã –æ—á–µ—Ä–µ–¥–∏)"
    echo "   - rsya_blocking_logs (–ª–æ–≥–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)"
    echo ""
    echo "üíæ –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω: $BACKUP_FILE"
    echo ""
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏"
    echo "üíæ –ë—ç–∫–∞–ø –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: $BACKUP_FILE"
    exit 1
fi

# ============================================================
# –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê
# ============================================================
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = CURRENT_SCHEMA()
  AND table_name IN (
    'partners',
    'referrals', 
    'referral_clicks',
    'partner_payouts',
    'rsya_queue_snapshots',
    'rsya_blocking_logs'
  )
ORDER BY table_name;
"

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ! –ú–æ–∂–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–æ–≤—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏!"
echo ""
